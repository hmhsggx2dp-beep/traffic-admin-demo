<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Ù„ÙˆØ­Ø© Ø£Ø¨Ùˆ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© - Ù†Ø³Ø®Ø© ØªØ¹Ù…Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --card2:#0f1830;
      --text:#eaf0ff; --muted:#9fb0d0; --line:rgba(255,255,255,.08);
      --brand:#6ee7ff; --brand2:#8b5cf6; --ok:#34d399; --warn:#fbbf24; --bad:#fb7185;
      --shadow: 0 18px 60px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Tahoma,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(110,231,255,.14), transparent 60%),
        radial-gradient(1000px 500px at 85% 20%, rgba(139,92,246,.18), transparent 60%),
        radial-gradient(900px 500px at 50% 90%, rgba(52,211,153,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
    }
    .app{max-width:1100px;margin:0 auto;}
    .topbar{
      position:sticky;top:0;z-index:10;
      padding:12px 10px;
      backdrop-filter:blur(14px);
      background:linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.65));
      border-bottom:1px solid var(--line);
    }
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg, rgba(110,231,255,.95), rgba(139,92,246,.95));
      box-shadow:0 10px 30px rgba(110,231,255,.15);
      display:grid;place-items:center;font-weight:900;color:#071021;
    }
    .title h1{margin:0;font-size:16px}
    .title p{margin:3px 0 0;font-size:12px;color:var(--muted);line-height:1.5}
    .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:14px;font-size:13px;
      cursor:pointer;user-select:none;
      transition:.15s transform,.15s background;
      display:flex;gap:8px;align-items:center;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn:active{transform:scale(.98)}
    .btn.primary{border:none;background:linear-gradient(135deg, rgba(110,231,255,.95), rgba(139,92,246,.95));color:#071021;font-weight:800}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted);background:rgba(255,255,255,.04)}
    .grid{display:grid;grid-template-columns:280px 1fr;gap:14px;margin-top:14px}
    @media (max-width:880px){.grid{grid-template-columns:1fr}}
    .nav,.main{
      background:rgba(17,26,46,.62);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .nav header,.main header{
      padding:14px;border-bottom:1px solid var(--line);
      background:linear-gradient(to bottom, rgba(255,255,255,.06), transparent);
    }
    .nav header .small{font-size:12px;color:var(--muted);margin-top:4px}
    .nav .items{padding:10px}
    .nav .item{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px;border-radius:14px;cursor:pointer;
      border:1px solid transparent;transition:.15s background,.15s border;margin-bottom:6px;
    }
    .nav .item:hover{background:rgba(255,255,255,.06)}
    .nav .item.active{background:rgba(110,231,255,.10);border-color:rgba(110,231,255,.18)}
    .nav .left{display:flex;gap:10px;align-items:center}
    .ico{
      width:34px;height:34px;border-radius:12px;display:grid;place-items:center;
      background:rgba(255,255,255,.06);border:1px solid var(--line);font-size:16px;
    }
    .badge{
      min-width:26px;height:22px;padding:0 8px;border-radius:999px;
      display:grid;place-items:center;font-size:12px;
      background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--muted);
    }
    .badge.hot{background:rgba(251,191,36,.12);border-color:rgba(251,191,36,.22);color:#ffe7b0}
    .badge.ok{background:rgba(52,211,153,.12);border-color:rgba(52,211,153,.22);color:#b7ffe2}
    .main header h2{margin:0;font-size:16px}
    .main header .sub{margin-top:4px;color:var(--muted);font-size:12px}
    .content{padding:14px}
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:1100px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:540px){.cards{grid-template-columns:1fr}}
    .kpi{
      background:rgba(15,24,48,.75);
      border:1px solid var(--line);
      border-radius:18px;padding:12px;position:relative;overflow:hidden;
    }
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:22px;font-weight:900;margin-top:6px}
    .kpi .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .delta{font-size:12px;margin-top:8px;display:inline-flex;gap:6px;align-items:center}
    .delta.up{color:var(--ok)} .delta.down{color:var(--bad)} .delta.flat{color:var(--warn)}
    .split{display:grid;grid-template-columns:1.35fr .65fr;gap:10px;margin-top:12px}
    @media (max-width:920px){.split{grid-template-columns:1fr}}
    .panel{background:rgba(15,24,48,.75);border:1px solid var(--line);border-radius:18px;overflow:hidden}
    .panel header{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.03)}
    .panel header h3{margin:0;font-size:14px}
    .panel header .meta{font-size:12px;color:var(--muted)}
    .panel .pbody{padding:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:right;vertical-align:middle}
    th{color:var(--muted);font-weight:700}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);font-size:12px;color:var(--muted);white-space:nowrap}
    .tag.ok{border-color:rgba(52,211,153,.25);background:rgba(52,211,153,.10);color:#b7ffe2}
    .tag.warn{border-color:rgba(251,191,36,.25);background:rgba(251,191,36,.10);color:#ffe7b0}
    .tag.bad{border-color:rgba(251,113,133,.25);background:rgba(251,113,133,.10);color:#ffd1db}
    .formgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.formgrid{grid-template-columns:1fr}}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field input,.field select,.field textarea{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);color:var(--text);outline:none;
    }
    .field textarea{min-height:92px;resize:vertical}
    .footnote{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.7}
    .toast{
      position:fixed;bottom:calc(env(safe-area-inset-bottom) + 14px);right:14px;left:14px;
      max-width:520px;margin:0 auto;padding:12px 14px;border-radius:16px;
      background:rgba(10,18,32,.90);border:1px solid var(--line);box-shadow:var(--shadow);
      display:none;align-items:center;justify-content:space-between;gap:10px;z-index:99;backdrop-filter:blur(14px);
    }
    .toast.show{display:flex}
    .toast .msg{font-size:13px}
    .toast .x{cursor:pointer;color:var(--muted);padding:6px 10px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.04)}
    .login{max-width:520px;margin:9vh auto 0;background:rgba(17,26,46,.62);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .login header{padding:18px;border-bottom:1px solid var(--line);background:linear-gradient(135deg, rgba(110,231,255,.16), rgba(139,92,246,.14))}
    .login header h2{margin:0;font-size:18px}
    .login header p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.7}
    .login .body{padding:16px 18px}
    .kbd{display:inline-block;padding:3px 8px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.05);font-size:12px;color:var(--muted)}
    .hintbox{margin-top:12px;padding:12px;border-radius:18px;border:1px dashed rgba(110,231,255,.25);background:rgba(110,231,255,.06);color:#dff9ff;font-size:12px;line-height:1.75}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .errorbox{
      max-width:820px;margin:22px auto 0;
      background:rgba(251,113,133,.08);
      border:1px solid rgba(251,113,133,.22);
      border-radius:22px;padding:14px 16px;line-height:1.8;
    }
    .smallbtn{font-size:12px;padding:8px 10px;border-radius:12px}
  </style>
</head>
<body>
  <div class="app" id="app"></div>

  <div class="toast" id="toast">
    <div class="msg" id="toastMsg">ØªÙ…</div>
    <div class="x" onclick="Toast.hide()">ØªÙ…</div>
  </div>

<script>
/* âœ… Ù†Ø³Ø®Ø© â€œØªØ´ØªØºÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„ÙØ§Øªâ€:
   - Ù„Ùˆ localStorage/sessionStorage Ù…Ù‚ÙÙˆÙ„ (Ø²ÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„ÙØ§Øª) Ù…Ø§ ÙŠÙˆÙ‚Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
   - ÙŠØµÙŠØ± ØªØ®Ø²ÙŠÙ†Ù‡ Ù…Ø¤Ù‚Øª (RAM) Ø¨Ø¯Ù„ Ù…Ø§ ÙŠÙ†Ù‡Ø§Ø±
*/

const LS_KEY = "abuabdullah_admin_v2";

/* ===== Safe storage wrapper ===== */
function makeSafeStorage(which){
  try{
    const s = (which === "session") ? window.sessionStorage : window.localStorage;
    const t = "__t";
    s.setItem(t,"1"); s.removeItem(t);
    return s;
  }catch(e){
    // fallback: in-memory store
    const mem = {};
    return {
      getItem:(k)=> (k in mem ? mem[k] : null),
      setItem:(k,v)=> { mem[k]=String(v); },
      removeItem:(k)=> { delete mem[k]; }
    };
  }
}
const safeLocal = makeSafeStorage("local");
const safeSession = makeSafeStorage("session");

const nowISO = () => new Date().toISOString();
const fmtSAR = (n) => new Intl.NumberFormat('ar-SA', {style:'currency', currency:'SAR', maximumFractionDigits:0}).format(n);

const Seed = {
  user: {name: "Ø£Ø¨Ùˆ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡", company: "Ø³Ù„Ø§Ù… Ø§Ù„Ù†Ø®Ø¨Ø©", role:"Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…"},
  approvals: [
    {id:"APR-201", type:"Ø·Ù„Ø¨ Ù…Ø´ØªØ±ÙŠØ§Øª", title:"Ù‚Ø·Ø¹ ØºÙŠØ§Ø± ÙƒØ¨ÙŠÙ†Ø©", amount: 2850, requester:"Ù…. Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", status:"Ù…Ø¹Ù„Ù‚", createdAt: nowISO(), note:"Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ØªØ¬Ø±Ø¨Ø©"},
    {id:"APR-202", type:"Ø³Ù„ÙØ©", title:"Ø³Ù„ÙØ© ÙÙ†ÙŠ", amount: 700, requester:"Ø£Ø¨Ùˆ ÙƒØ±ÙŠÙ…", status:"Ù…ÙˆØ§ÙÙ‚", createdAt: nowISO(), note:""},
    {id:"APR-203", type:"ØªØ¹Ù‡Ø¯", title:"Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¹Ø¯Ø§Øª", amount: 0, requester:"Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†", status:"Ù…Ø±ÙÙˆØ¶", createdAt: nowISO(), note:"Ù†Ø§Ù‚Øµ ØªÙˆÙ‚ÙŠØ¹"}
  ],
  cash: [
    {id:"C-01", kind:"Ø¯Ø®Ù„", title:"Ø¯ÙØ¹Ø© Ù…Ø´Ø±ÙˆØ¹", amount: 45000, date: nowISO(), ref:"INV-1001"},
    {id:"C-02", kind:"Ù…ØµØ±ÙˆÙ", title:"ÙˆÙ‚ÙˆØ¯ ÙˆÙ†Ø«Ø±ÙŠØ§Øª", amount: 520, date: nowISO(), ref:"EXP-44"},
    {id:"C-03", kind:"Ù…ØµØ±ÙˆÙ", title:"Ù…Ø´ØªØ±ÙŠØ§Øª Ù…ÙˆØ§Ø¯", amount: 2850, date: nowISO(), ref:"APR-201"},
  ],
  invoices: [
    {id:"INV-1001", client:"Ø§Ù„Ù…Ø±ÙˆØ±", amount: 45000, status:"Ù…Ø¯ÙÙˆØ¹Ø©", date: nowISO()},
    {id:"INV-1002", client:"Ø£Ù…Ø§Ù†Ø©", amount: 18000, status:"Ù‚ÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„", date: nowISO()},
  ],
  tasks: [
    {id:"T-11", title:"Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¦Ø­ M2M", owner:"Ø£Ø¨Ùˆ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡", due:"ØºØ¯Ù‹Ø§", status:"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°"},
    {id:"T-12", title:"ØªØ¬Ù‡ÙŠØ² Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙˆØ±", owner:"Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", due:"Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹", status:"Ø¬Ø¯ÙŠØ¯Ø©"},
    {id:"T-13", title:"Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±", owner:"Ø£Ø¨Ùˆ Ù†Ø§ÙŠÙ", due:"Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±", status:"Ø¬Ø¯ÙŠØ¯Ø©"},
  ]
};

function loadState(){
  const raw = safeLocal.getItem(LS_KEY);
  if(!raw){
    safeLocal.setItem(LS_KEY, JSON.stringify(Seed));
    return JSON.parse(JSON.stringify(Seed));
  }
  try { return JSON.parse(raw); } catch(e){
    safeLocal.setItem(LS_KEY, JSON.stringify(Seed));
    return JSON.parse(JSON.stringify(Seed));
  }
}
function saveState(s){ safeLocal.setItem(LS_KEY, JSON.stringify(s)); }

let state = loadState();

const Toast = {
  show(msg){
    const t = document.getElementById('toast');
    document.getElementById('toastMsg').textContent = msg;
    t.classList.add('show');
    clearTimeout(this._to);
    this._to = setTimeout(()=>this.hide(), 2200);
  },
  hide(){ document.getElementById('toast').classList.remove('show'); }
};

function el(tag, attrs={}, children=[]){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k === "class") e.className = v;
    else if(k === "html") e.innerHTML = v;
    else if(k.startsWith("on") && typeof v === "function") e.addEventListener(k.slice(2), v);
    else e.setAttribute(k, v);
  });
  (Array.isArray(children)? children:[children]).forEach(c=>{
    if(c===null || c===undefined) return;
    if(typeof c === "string") e.appendChild(document.createTextNode(c));
    else e.appendChild(c);
  });
  return e;
}

let current = "dashboard";
function route(to){ current = to; renderApp(); }

function countPending(){ return state.approvals.filter(a=>a.status==="Ù…Ø¹Ù„Ù‚").length; }

function kpiData(){
  const income = state.cash.filter(x=>x.kind==="Ø¯Ø®Ù„").reduce((s,x)=>s+x.amount,0);
  const expense = state.cash.filter(x=>x.kind==="Ù…ØµØ±ÙˆÙ").reduce((s,x)=>s+x.amount,0);
  const pending = countPending();
  const collecting = state.invoices.filter(i=>i.status!=="Ù…Ø¯ÙÙˆØ¹Ø©").reduce((s,i)=>s+i.amount,0);
  return {income, expense, pending, collecting};
}

function renderTopbar(){
  return el("div",{class:"topbar"},[
    el("div",{class:"row"},[
      el("div",{class:"brand"},[
        el("div",{class:"logo"},["SN"]),
        el("div",{class:"title"},[
          el("h1",{html:`Ù„ÙˆØ­Ø© ${state.user.name} Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©`}),
          el("p",{html:`${state.user.company} â€¢ ${state.user.role} â€¢ ØªØ¹Ù…Ù„ Ø­ØªÙ‰ Ø¯Ø§Ø®Ù„ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ù„ÙØ§Øª`})
        ])
      ]),
      el("div",{class:"actions"},[
        el("span",{class:"pill"},[ safeLocal.getItem("__dummy")===null ? "Ø¬Ø§Ù‡Ø²" : "Ø¬Ø§Ù‡Ø²" ]),
        el("button",{class:"btn", onclick:()=>Toast.show("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø©")},["ØªØ­Ø¯ÙŠØ«"]),
        el("button",{class:"btn primary", onclick:()=>openQuickAdd()},["Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©"]),
      ])
    ])
  ]);
}

function renderNav(){
  const items = [
    {id:"dashboard", name:"Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", icon:"ğŸ ", badge:"ok", value:"Ø¬Ø§Ù‡Ø²"},
    {id:"approvals", name:"Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª", icon:"âœ…", badge: countPending()? "hot":"ok", value: String(countPending())},
    {id:"cash", name:"Ø§Ù„Ù…Ø§Ù„ÙŠØ©", icon:"ğŸ’³"},
    {id:"invoices", name:"Ø§Ù„ÙÙˆØ§ØªÙŠØ±", icon:"ğŸ§¾"},
    {id:"tasks", name:"Ø§Ù„Ù…Ù‡Ø§Ù…", icon:"ğŸ“Œ"},
    {id:"settings", name:"Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", icon:"âš™ï¸"},
  ];
  return el("div",{class:"nav"},[
    el("header",{},[
      el("div",{style:"font-weight:800"},["Ø§Ù„Ø£Ù‚Ø³Ø§Ù…"]),
      el("div",{class:"small"},[
        "Ø¥Ø°Ø§ Ø¸Ù‡Ø± Ù„Ùƒ Ù‚Ø¨Ù„ ÙƒØ°Ø§ ØµÙØ­Ø© ÙØ§Ø¶ÙŠØ©: Ù‡Ø°Ù‡ Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø©.",
        el("br"),"",
        "ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (ÙˆÙ„Ùˆ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù‚ÙÙˆÙ„ ÙŠØµÙŠØ± Ù…Ø¤Ù‚Øª)."
      ])
    ]),
    el("div",{class:"items"}, items.map(it=>{
      return el("div",{class:"item "+(current===it.id?"active":""), onclick:()=>route(it.id)},[
        el("div",{class:"left"},[
          el("div",{class:"ico"},[it.icon]),
          el("div",{},[
            el("div",{style:"font-weight:800;font-size:13px"},[it.name]),
            el("div",{style:"font-size:12px;color:var(--muted);margin-top:2px"},[
              it.id==="approvals" ? "Ø·Ù„Ø¨Ø§Øª ØªÙ†ØªØ¸Ø± Ø§Ø¹ØªÙ…Ø§Ø¯Ùƒ" :
              it.id==="cash" ? "Ø¯Ø®Ù„ ÙˆÙ…ØµØ±ÙˆÙØ§Øª ÙˆØªÙ‚Ø§Ø±ÙŠØ±" :
              it.id==="invoices" ? "Ø¥ØµØ¯Ø§Ø± ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­ØµÙŠÙ„" :
              it.id==="tasks" ? "ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø¹Ù…Ù„" :
              it.id==="settings" ? "Ù‡ÙˆÙŠØ© ÙˆØªØ®ØµÙŠØµ" : "Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø©"
            ])
          ])
        ]),
        it.value ? el("div",{class:"badge "+(it.badge||"")},[it.value]) : el("div",{})
      ])
    }))
  ]);
}

function renderMain(){
  const title = ({
    dashboard:"Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…",
    approvals:"Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª",
    cash:"Ø§Ù„Ù…Ø§Ù„ÙŠØ©",
    invoices:"Ø§Ù„ÙÙˆØ§ØªÙŠØ±",
    tasks:"Ø§Ù„Ù…Ù‡Ø§Ù…",
    settings:"Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"
  })[current] || "Ù„ÙˆØ­Ø©";
  const sub = ({
    dashboard:"Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© + Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª",
    approvals:"Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø£Ùˆ Ø±ÙØ¶Ù‡Ø§ Ù…Ø¹ Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
    cash:"Ø¥Ø¶Ø§ÙØ© Ø¯Ø®Ù„/Ù…ØµØ±ÙˆÙ ÙˆÙ…Ù„Ø®Øµ",
    invoices:"Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­ØµÙŠÙ„",
    tasks:"Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù… Ø¨Ø³ÙŠØ·Ø©",
    settings:"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡ÙˆÙŠØ© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
  })[current] || "";
  return el("div",{class:"main"},[
    el("header",{},[
      el("div",{},[
        el("h2",{},[title]),
        el("div",{class:"sub"},[sub])
      ]),
      el("div",{style:"display:flex;gap:8px;align-items:center;flex-wrap:wrap"},[
        el("span",{class:"pill"},["Ù†Ø³Ø®Ø© Ø¹Ø±Ø¶ Ø¹Ø±Ø¨ÙŠØ©"]),
        el("span",{class:"pill mono"},[new Date().toLocaleString('ar-SA')])
      ])
    ]),
    el("div",{class:"content"},[ renderPage() ])
  ]);
}

function renderDashboard(){
  const k = kpiData();
  const kpis = [
    {label:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„", value: fmtSAR(k.income), hint:"Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„", delta:{t:"Ø§Ø±ØªÙØ§Ø¹", cls:"up", ico:"â¬†ï¸"}},
    {label:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª", value: fmtSAR(k.expense), hint:"Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª", delta:{t:"Ù…ØªØ§Ø¨Ø¹Ø©", cls:"flat", ico:"ğŸŸ¡"}},
    {label:"Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©", value: String(k.pending), hint:"ØªØ­ØªØ§Ø¬ Ù‚Ø±Ø§Ø± Ù…Ù†Ùƒ", delta:{t: k.pending? "Ù…Ù‡Ù…":"ØªÙ…Ø§Ù…", cls: k.pending? "down":"up", ico: k.pending? "âš ï¸":"âœ…"}},
    {label:"ØªØ­ØµÙŠÙ„ Ù…ØªÙˆÙ‚Ø¹", value: fmtSAR(k.collecting), hint:"ÙÙˆØ§ØªÙŠØ± ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©", delta:{t:"Ù‚ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©", cls:"flat", ico:"ğŸ§¾"}}
  ];
  const recent = [...state.cash].slice(-5).reverse();
  return el("div",{},[
    el("div",{class:"cards"}, kpis.map(x=>{
      return el("div",{class:"kpi"},[
        el("div",{class:"label"},[x.label]),
        el("div",{class:"value"},[x.value]),
        el("div",{class:"hint"},[x.hint]),
        el("div",{class:"delta "+x.delta.cls},[x.delta.ico, x.delta.t])
      ])
    })),
    el("div",{class:"split"},[
      el("div",{class:"panel"},[
        el("header",{},[
          el("h3",{},["Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©"]),
          el("div",{class:"meta"},["Ø¢Ø®Ø± 5 Ø­Ø±ÙƒØ§Øª"])
        ]),
        el("div",{class:"pbody"},[
          el("table",{},[
            el("thead",{},[
              el("tr",{},[
                el("th",{},["Ø§Ù„Ù†ÙˆØ¹"]),
                el("th",{},["Ø§Ù„ÙˆØµÙ"]),
                el("th",{},["Ø§Ù„Ù…Ø¨Ù„Øº"]),
                el("th",{},["Ø§Ù„Ù…Ø±Ø¬Ø¹"])
              ])
            ]),
            el("tbody",{}, recent.map(r=>{
              const cls = r.kind==="Ø¯Ø®Ù„" ? "ok" : "warn";
              return el("tr",{},[
                el("td",{},[ el("span",{class:"tag "+cls},[r.kind]) ]),
                el("td",{},[r.title]),
                el("td",{},[fmtSAR(r.amount)]),
                el("td",{},[r.ref || "-"])
              ])
            }))
          ]),
          el("div",{class:"footnote"},[
            "Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©. Ù„Ùˆ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù‚ÙÙˆÙ„ ÙÙŠ Ø§Ù„Ø¢ÙŠÙÙˆÙ†ØŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙƒÙˆÙ† Ù…Ø¤Ù‚ØªØ© ÙˆØªØ±ÙˆØ­ Ø¥Ø°Ø§ Ø³ÙƒØ±Øª Ø§Ù„ØµÙØ­Ø©."
          ])
        ])
      ]),
      el("div",{class:"panel"},[
        el("header",{},[
          el("h3",{},["Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶"]),
          el("div",{class:"meta"},["Ù…Ù‡Ù…"])
        ]),
        el("div",{class:"pbody"},[
          el("div",{class:"hintbox"},[
            "Ø¥Ø°Ø§ ØªØ¨ÙŠÙ‡Ø§ (ÙƒØ£ÙŠÙ‚ÙˆÙ†Ø© ØªØ·Ø¨ÙŠÙ‚) Ù„Ø§Ø²Ù… Ø±Ø§Ø¨Ø· ÙˆÙŠØ¨.",
            el("br"),"",
            "Ù„ÙƒÙ† Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙƒØ±Ø© Ø§Ù„Ø¢Ù†: Ø§ÙØªØ­Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ®Ù„Ø§Øµ â€” Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© ØªØ´ØªØºÙ„ Ù‡Ù†Ø§Ùƒ."
          ]),
          el("div",{style:"margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"},[
            el("button",{class:"btn primary", onclick:()=>route('approvals')},["Ø±ÙˆØ­ Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª"]),
            el("button",{class:"btn", onclick:()=>route('cash')},["Ø£Ø¶Ù Ù…ØµØ±ÙˆÙ"]),
          ])
        ])
      ]),
    ])
  ]);
}

function renderApprovals(){
  return el("div",{},[
    el("div",{class:"panel"},[
      el("header",{},[
        el("h3",{},["Ø·Ù„Ø¨Ø§Øª ØªØ­ØªØ§Ø¬ Ù‚Ø±Ø§Ø±"]),
        el("div",{class:"meta"},[`Ù…Ø¹Ù„Ù‚: ${countPending()}`])
      ]),
      el("div",{class:"pbody"},[
        el("table",{},[
          el("thead",{},[
            el("tr",{},[
              el("th",{},["Ø±Ù‚Ù…"]),
              el("th",{},["Ø§Ù„Ù†ÙˆØ¹"]),
              el("th",{},["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"]),
              el("th",{},["Ø§Ù„Ù…Ø¨Ù„Øº"]),
              el("th",{},["Ø§Ù„Ù…Ù‚Ø¯Ù…"]),
              el("th",{},["Ø§Ù„Ø­Ø§Ù„Ø©"]),
              el("th",{},["Ø¥Ø¬Ø±Ø§Ø¡"])
            ])
          ]),
          el("tbody",{}, state.approvals.map(a=>{
            const tagCls = a.status==="Ù…ÙˆØ§ÙÙ‚" ? "ok" : a.status==="Ù…Ø±ÙÙˆØ¶" ? "bad" : "warn";
            return el("tr",{},[
              el("td",{},[a.id]),
              el("td",{},[a.type]),
              el("td",{},[a.title]),
              el("td",{},[fmtSAR(a.amount)]),
              el("td",{},[a.requester]),
              el("td",{},[ el("span",{class:"tag "+tagCls},[a.status]) ]),
              el("td",{},[
                el("button",{class:"btn", onclick:()=>openDecision(a.id)},["Ù‚Ø±Ø§Ø±"])
              ])
            ])
          }))
        ]),
        el("div",{class:"footnote"},["Ø§Ø¶ØºØ· Ù‚Ø±Ø§Ø± ÙˆØ§ÙƒØªØ¨: Ù…ÙˆØ§ÙÙ‚ Ø£Ùˆ Ù…Ø±ÙÙˆØ¶ Ø£Ùˆ Ù…Ø¹Ù„Ù‚."])
      ])
    ])
  ]);
}

function renderCash(){
  const income = state.cash.filter(x=>x.kind==="Ø¯Ø®Ù„").reduce((s,x)=>s+x.amount,0);
  const expense = state.cash.filter(x=>x.kind==="Ù…ØµØ±ÙˆÙ").reduce((s,x)=>s+x.amount,0);
  return el("div",{},[
    el("div",{class:"panel"},[
      el("header",{},[
        el("h3",{},["Ø¥Ø¶Ø§ÙØ© Ø­Ø±ÙƒØ© Ù…Ø§Ù„ÙŠØ©"]),
        el("div",{class:"meta"},["Ø³Ø±ÙŠØ¹"])
      ]),
      el("div",{class:"pbody"},[
        el("div",{class:"formgrid"},[
          el("div",{class:"field"},[
            el("label",{},["Ø§Ù„Ù†ÙˆØ¹"]),
            el("select",{id:"cashKind"},[
              el("option",{value:"Ø¯Ø®Ù„"},["Ø¯Ø®Ù„"]),
              el("option",{value:"Ù…ØµØ±ÙˆÙ"},["Ù…ØµØ±ÙˆÙ"])
            ])
          ]),
          el("div",{class:"field"},[
            el("label",{},["Ø§Ù„Ù…Ø¨Ù„Øº"]),
            el("input",{id:"cashAmount", type:"number", placeholder:"Ù…Ø«Ø§Ù„ 1500"})
          ]),
          el("div",{class:"field"},[
            el("label",{},["Ø§Ù„ÙˆØµÙ"]),
            el("input",{id:"cashTitle", type:"text", placeholder:"Ù…Ø«Ø§Ù„ ÙˆÙ‚ÙˆØ¯ Ø£Ùˆ Ø¯ÙØ¹Ø© Ù…Ø´Ø±ÙˆØ¹"})
          ]),
          el("div",{class:"field"},[
            el("label",{},["Ø§Ù„Ù…Ø±Ø¬Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"]),
            el("input",{id:"cashRef", type:"text", placeholder:"Ù…Ø«Ø§Ù„ INV-1003"})
          ]),
        ]),
        el("div",{style:"margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"},[
          el("button",{class:"btn primary", onclick:()=>addCash()},["Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©"]),
        ]),
        el("div",{class:"footnote"},[`Ù…Ù„Ø®Øµ: Ø§Ù„Ø¯Ø®Ù„ ${fmtSAR(income)} â€¢ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ${fmtSAR(expense)}`])
      ])
    ])
  ]);
}

function renderInvoices(){
  return el("div",{},[
    el("div",{class:"panel"},[
      el("header",{},[
        el("h3",{},["Ø§Ù„ÙÙˆØ§ØªÙŠØ±"]),
        el("div",{class:"meta"},["Ø¥Ù†Ø´Ø§Ø¡ ÙˆÙ…ØªØ§Ø¨Ø¹Ø©"])
      ]),
      el("div",{class:"pbody"},[
        el("div",{class:"formgrid"},[
          el("div",{class:"field"},[
            el("label",{},["Ø§Ù„Ø¹Ù…ÙŠÙ„"]),
            el("input",{id:"invClient", type:"text", placeholder:"Ù…Ø«Ø§Ù„ Ø§Ù„Ù…Ø±ÙˆØ±"})
          ]),
          el("div",{class:"field"},[
            el("label",{},["Ø§Ù„Ù…Ø¨Ù„Øº"]),
            el("input",{id:"invAmount", type:"number", placeholder:"Ù…Ø«Ø§Ù„ 12000"})
          ]),
          el("div",{class:"field"},[
            el("label",{},["Ø§Ù„Ø­Ø§Ù„Ø©"]),
            el("select",{id:"invStatus"},[
              el("option",{value:"Ù‚ÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„"},["Ù‚ÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„"]),
              el("option",{value:"Ù…Ø¯ÙÙˆØ¹Ø©"},["Ù…Ø¯ÙÙˆØ¹Ø©"]),
              el("option",{value:"Ù…ØªØ£Ø®Ø±Ø©"},["Ù…ØªØ£Ø®Ø±Ø©"])
            ])
          ]),
          el("div",{class:"field"},[
            el("label",{},["Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"]),
            el("input",{id:"invNote", type:"text", placeholder:"Ù…Ø«Ø§Ù„ Ø¯ÙØ¹Ø© Ø£ÙˆÙ„Ù‰"})
          ]),
        ]),
        el("div",{style:"margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"},[
          el("button",{class:"btn primary", onclick:()=>addInvoice()},["Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©"]),
        ]),
        el("div",{style:"margin-top:12px"},[
          el("table",{},[
            el("thead",{},[
              el("tr",{},[
                el("th",{},["Ø±Ù‚Ù…"]),
                el("th",{},["Ø§Ù„Ø¹Ù…ÙŠÙ„"]),
                el("th",{},["Ø§Ù„Ù…Ø¨Ù„Øº"]),
                el("th",{},["Ø§Ù„Ø­Ø§Ù„Ø©"]),
                el("th",{},["Ø¥Ø¬Ø±Ø§Ø¡"])
              ])
            ]),
            el("tbody",{}, state.invoices.map(i=>{
              const cls = i.status==="Ù…Ø¯ÙÙˆØ¹Ø©" ? "ok" : i.status==="Ù…ØªØ£Ø®Ø±Ø©" ? "bad" : "warn";
              return el("tr",{},[
                el("td",{},[i.id]),
                el("td",{},[i.client]),
                el("td",{},[fmtSAR(i.amount)]),
                el("td",{},[ el("span",{class:"tag "+cls},[i.status]) ]),
                el("td",{},[
                  el("button",{class:"btn", onclick:()=>toggleInvoice(i.id)},["ØªØºÙŠÙŠØ±"])
                ])
              ])
            }))
          ])
        ]),
        el("div",{class:"footnote"},["ØªØºÙŠÙŠØ± = ÙŠØ¯ÙˆØ± Ø¨ÙŠÙ† Ù‚ÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„ Ø«Ù… Ù…Ø¯ÙÙˆØ¹Ø© Ø«Ù… Ù…ØªØ£Ø®Ø±Ø©."])
      ])
    ])
  ]);
}

function renderTasks(){
  return el("div",{},[
    el("div",{class:"panel"},[
      el("header",{},[
        el("h3",{},["Ø§Ù„Ù…Ù‡Ø§Ù…"]),
        el("div",{class:"meta"},["Ø®ÙÙŠÙØ©"])
      ]),
      el("div",{class:"pbody"},[
        el("div",{class:"formgrid"},[
          el("div",{class:"field"},[
            el("label",{},["Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©"]),
            el("input",{id:"taskTitle", type:"text", placeholder:"Ù…Ø«Ø§Ù„ Ø§Ø¹ØªÙ…Ø§Ø¯ Ù…ØµØ±ÙˆÙØ§Øª"})
          ]),
          el("div",{class:"field"},[
            el("label",{},["Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„"]),
            el("input",{id:"taskOwner", type:"text", placeholder:"Ù…Ø«Ø§Ù„ Ø£Ø¨Ùˆ Ù†Ø§ÙŠÙ"})
          ]),
          el("div",{class:"field"},[
            el("label",{},["Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚"]),
            el("input",{id:"taskDue", type:"text", placeholder:"Ù…Ø«Ø§Ù„ ØºØ¯Ù‹Ø§"})
          ]),
          el("div",{class:"field"},[
            el("label",{},["Ø§Ù„Ø­Ø§Ù„Ø©"]),
            el("select",{id:"taskStatus"},[
              el("option",{value:"Ø¬Ø¯ÙŠØ¯Ø©"},["Ø¬Ø¯ÙŠØ¯Ø©"]),
              el("option",{value:"Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°"},["Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°"]),
              el("option",{value:"Ù…Ù†ØªÙ‡ÙŠØ©"},["Ù…Ù†ØªÙ‡ÙŠØ©"])
            ])
          ]),
        ]),
        el("div",{style:"margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"},[
          el("button",{class:"btn primary", onclick:()=>addTask()},["Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©"]),
        ]),
        el("div",{style:"margin-top:12px"},[
          el("table",{},[
            el("thead",{},[
              el("tr",{},[
                el("th",{},["Ø±Ù‚Ù…"]),
                el("th",{},["Ø§Ù„Ù…Ù‡Ù…Ø©"]),
                el("th",{},["Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„"]),
                el("th",{},["Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚"]),
                el("th",{},["Ø§Ù„Ø­Ø§Ù„Ø©"]),
                el("th",{},["Ø¥Ø¬Ø±Ø§Ø¡"])
              ])
            ]),
            el("tbody",{}, state.tasks.map(t=>{
              const cls = t.status==="Ù…Ù†ØªÙ‡ÙŠØ©" ? "ok" : t.status==="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ? "warn" : "";
              return el("tr",{},[
                el("td",{},[t.id]),
                el("td",{},[t.title]),
                el("td",{},[t.owner]),
                el("td",{},[t.due]),
                el("td",{},[ el("span",{class:"tag "+(cls||"")},[t.status]) ]),
                el("td",{},[
                  el("button",{class:"btn", onclick:()=>toggleTask(t.id)},["ØªØºÙŠÙŠØ±"])
                ])
              ])
            }))
          ])
        ])
      ])
    ])
  ]);
}

function renderSettings(){
  return el("div",{},[
    el("div",{class:"panel"},[
      el("header",{},[
        el("h3",{},["Ù‡ÙˆÙŠØ© Ø§Ù„Ù„ÙˆØ­Ø©"]),
        el("div",{class:"meta"},["ØªØ¹Ø¯ÙŠÙ„ ÙÙˆØ±ÙŠ"])
      ]),
      el("div",{class:"pbody"},[
        el("div",{class:"formgrid"},[
          el("div",{class:"field"},[
            el("label",{},["Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±"]),
            el("input",{id:"setName", type:"text", value: state.user.name})
          ]),
          el("div",{class:"field"},[
            el("label",{},["Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©"]),
            el("input",{id:"setCompany", type:"text", value: state.user.company})
          ]),
          el("div",{class:"field"},[
            el("label",{},["Ø§Ù„Ù…Ù†ØµØ¨"]),
            el("input",{id:"setRole", type:"text", value: state.user.role})
          ]),
          el("div",{class:"field"},[
            el("label",{},["Ø§Ù„Ù…Ø¸Ù‡Ø±"]),
            el("select",{id:"setTheme"},[
              el("option",{value:"dark"},["Ø¯Ø§ÙƒÙ†"]),
              el("option",{value:"mid"},["Ø£Ø²Ø±Ù‚ ÙØ®Ù…"]),
              el("option",{value:"ink"},["Ø¨Ù†ÙØ³Ø¬ÙŠ"])
            ])
          ]),
        ]),
        el("div",{style:"margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"},[
          el("button",{class:"btn primary", onclick:()=>saveSettings()},["Ø­ÙØ¸"]),
          el("button",{class:"btn", onclick:()=>resetAll()},["Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·"])
        ]),
        el("div",{class:"footnote"},["Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ù…ÙÙŠØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø£Ø¨Ùˆ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡."])
      ])
    ])
  ]);
}

function renderPage(){
  if(current==="dashboard") return renderDashboard();
  if(current==="approvals") return renderApprovals();
  if(current==="cash") return renderCash();
  if(current==="invoices") return renderInvoices();
  if(current==="tasks") return renderTasks();
  if(current==="settings") return renderSettings();
  return el("div",{},["ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"]);
}

/* ===== Actions ===== */
function addCash(){
  const kind = document.getElementById('cashKind').value;
  const amount = Number(document.getElementById('cashAmount').value || 0);
  const title = (document.getElementById('cashTitle').value || "").trim();
  const ref = (document.getElementById('cashRef').value || "").trim();
  if(!title || !amount){ Toast.show("Ø§ÙƒØªØ¨ Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…Ø¨Ù„Øº"); return; }
  const id = "C-" + Math.floor(1000 + Math.random()*9000);
  state.cash.push({id, kind, title, amount, date: nowISO(), ref});
  saveState(state);
  Toast.show("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©");
  route("dashboard");
}
function addInvoice(){
  const client = (document.getElementById('invClient').value || "").trim();
  const amount = Number(document.getElementById('invAmount').value || 0);
  const status = document.getElementById('invStatus').value;
  if(!client || !amount){ Toast.show("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø¨Ù„Øº"); return; }
  const id = "INV-" + Math.floor(1000 + Math.random()*9000);
  state.invoices.unshift({id, client, amount, status, date: nowISO()});
  saveState(state);
  Toast.show("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
  route("invoices");
}
function toggleInvoice(id){
  const i = state.invoices.find(x=>x.id===id);
  if(!i) return;
  i.status = (i.status==="Ù‚ÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„") ? "Ù…Ø¯ÙÙˆØ¹Ø©" : (i.status==="Ù…Ø¯ÙÙˆØ¹Ø©" ? "Ù…ØªØ£Ø®Ø±Ø©" : "Ù‚ÙŠØ¯ Ø§Ù„ØªØ­ØµÙŠÙ„");
  saveState(state);
  Toast.show("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
  route("invoices");
}
function toggleTask(id){
  const t = state.tasks.find(x=>x.id===id);
  if(!t) return;
  t.status = (t.status==="Ø¬Ø¯ÙŠØ¯Ø©") ? "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" : (t.status==="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ? "Ù…Ù†ØªÙ‡ÙŠØ©" : "Ø¬Ø¯ÙŠØ¯Ø©");
  saveState(state);
  Toast.show("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©");
  route("tasks");
}
function addTask(){
  const title = (document.getElementById('taskTitle').value || "").trim();
  const owner = (document.getElementById('taskOwner').value || "").trim();
  const due = (document.getElementById('taskDue').value || "").trim();
  const status = document.getElementById('taskStatus').value;
  if(!title || !owner){ Toast.show("Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„"); return; }
  const id = "T-" + Math.floor(100 + Math.random()*900);
  state.tasks.unshift({id, title, owner, due: due||"â€”", status});
  saveState(state);
  Toast.show("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©");
  route("tasks");
}
function openDecision(id){
  const a = state.approvals.find(x=>x.id===id);
  if(!a){Toast.show("ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); return;}
  const note = prompt("Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø«Ù… OK", a.note || "");
  const action = prompt("Ø§ÙƒØªØ¨: Ù…ÙˆØ§ÙÙ‚ Ø£Ùˆ Ù…Ø±ÙÙˆØ¶ Ø£Ùˆ Ù…Ø¹Ù„Ù‚", a.status);
  if(!action) return;
  const s = action.trim();
  if(!["Ù…ÙˆØ§ÙÙ‚","Ù…Ø±ÙÙˆØ¶","Ù…Ø¹Ù„Ù‚"].includes(s)){ Toast.show("Ø§ÙƒØªØ¨ Ù…ÙˆØ§ÙÙ‚ Ø£Ùˆ Ù…Ø±ÙÙˆØ¶ Ø£Ùˆ Ù…Ø¹Ù„Ù‚"); return; }
  a.status = s;
  a.note = (note||"").trim();
  saveState(state);
  Toast.show("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø§Ø±");
  route("approvals");
}
function openQuickAdd(){
  const which = prompt("Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©: Ø§ÙƒØªØ¨ (Ù…ØµØ±ÙˆÙ) Ø£Ùˆ (ÙØ§ØªÙˆØ±Ø©) Ø£Ùˆ (Ù…Ù‡Ù…Ø©)");
  if(!which) return;
  const w = which.trim();
  if(w==="Ù…ØµØ±ÙˆÙ"){ route("cash"); setTimeout(()=>{ const k=document.getElementById('cashKind'); if(k) k.value="Ù…ØµØ±ÙˆÙ"; }, 50); }
  else if(w==="ÙØ§ØªÙˆØ±Ø©"){ route("invoices"); }
  else if(w==="Ù…Ù‡Ù…Ø©"){ route("tasks"); }
  else Toast.show("Ø§ÙƒØªØ¨ Ù…ØµØ±ÙˆÙ Ø£Ùˆ ÙØ§ØªÙˆØ±Ø© Ø£Ùˆ Ù…Ù‡Ù…Ø©");
}
function saveSettings(){
  const name = (document.getElementById('setName').value || "").trim();
  const company = (document.getElementById('setCompany').value || "").trim();
  const role = (document.getElementById('setRole').value || "").trim();
  const theme = document.getElementById('setTheme').value;
  if(name) state.user.name=name;
  if(company) state.user.company=company;
  if(role) state.user.role=role;

  if(theme==="mid"){ document.documentElement.style.setProperty('--brand','#60a5fa'); document.documentElement.style.setProperty('--brand2','#22c55e'); }
  else if(theme==="ink"){ document.documentElement.style.setProperty('--brand','#a78bfa'); document.documentElement.style.setProperty('--brand2','#6ee7ff'); }
  else { document.documentElement.style.setProperty('--brand','#6ee7ff'); document.documentElement.style.setProperty('--brand2','#8b5cf6'); }

  saveState(state);
  Toast.show("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
  renderApp();
}
function resetAll(){
  if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·ØŸ")) return;
  state = JSON.parse(JSON.stringify(Seed));
  saveState(state);
  Toast.show("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·");
  route("dashboard");
}

/* ===== App render with safe session ===== */
function renderLogin(){
  return el("div",{class:"login"},[
    el("header",{},[
      el("h2",{},["ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¯Ø§Ø±ÙŠ ÙØ®Ù…"]),
      el("p",{},[
        "Ù†Ø³Ø®Ø© Ø¹Ø±Ø¨ÙŠØ© ØªØ¬Ø±ÙŠØ¨ÙŠØ© ØªØ¹Ù…Ù„ Ø¯Ø§Ø®Ù„ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ù„ÙØ§Øª.",
        el("br"),"",
        "Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ: ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ",
        el("span",{class:"kbd mono"},["1234"])
      ])
    ]),
    el("div",{class:"body"},[
      el("div",{class:"field"},[
        el("label",{},["ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"]),
        el("input",{id:"pw", type:"password", placeholder:"Ø§ÙƒØªØ¨ 1234"})
      ]),
      el("div",{style:"margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"},[
        el("button",{class:"btn primary", onclick:()=>doLogin()},["Ø¯Ø®ÙˆÙ„"]),
        el("button",{class:"btn smallbtn", onclick:()=>{safeSession.setItem("logged_in","1"); renderApp(); Toast.show("ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¹Ø±Ø¶");}},["ØªØ¬Ø§ÙˆØ²"])
      ]),
      el("div",{class:"hintbox"},[
        "Ù„Ùˆ Ù…Ø§ Ø§Ø´ØªØºÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ Ø¬Ù‡Ø§Ø²ÙƒØŒ Ø¹Ø§Ø¯ÙŠ â€” Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ´ØªØºÙ„ Ù…Ø¤Ù‚Øª.",
        el("br"),"",
        "Ø¥Ø°Ø§ ØªØ¨ÙŠ ØªØ­ÙØ¸ Ø¯Ø§Ø¦Ù… ÙˆØªØ¶ÙŠÙ Ø£ÙŠÙ‚ÙˆÙ†Ø©: Ù†Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ù„Ø±Ø§Ø¨Ø· ÙˆÙŠØ¨ Ù„Ø§Ø­Ù‚Ù‹Ø§."
      ])
    ])
  ]);
}
function doLogin(){
  const pw = (document.getElementById('pw').value || "").trim();
  if(pw==="1234"){
    safeSession.setItem("logged_in","1");
    Toast.show("Ù‡Ù„Ø§ Ø£Ø¨Ùˆ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡");
    renderApp();
  }else Toast.show("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙ„Ø·");
}

function renderApp(){
  const app = document.getElementById("app");
  app.innerHTML = "";
  const logged = safeSession.getItem("logged_in")==="1";
  if(!logged){
    app.appendChild(renderLogin());
    return;
  }
  app.appendChild(renderTopbar());
  app.appendChild(el("div",{class:"grid"},[ renderNav(), renderMain() ]));
}

/* ===== Safety: show error if JS blocked completely ===== */
try{
  renderApp();
}catch(err){
  const app = document.getElementById("app");
  app.innerHTML = "";
  app.appendChild(el("div",{class:"errorbox"},[
    el("div",{style:"font-weight:900;margin-bottom:6px"},["Ù…Ø§ Ø§Ø´ØªØºÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©"]),
    el("div",{},[
      "Ø­Ù„ Ø³Ø±ÙŠØ¹: Ø§ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù…Ù† Safari (Ø§Ùˆ Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙƒØ±Ø§Ø¨Ø· ÙˆÙŠØ¨).",
      el("br"),"",
      "Ø§Ù„Ø®Ø·Ø£: ",
      el("span",{class:"mono"},[String(err)])
    ])
  ]));
}
</script>
</body>
</html>
